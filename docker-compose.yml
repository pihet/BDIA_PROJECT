services:
  # Car 데이터베이스 (소스 DB)
  mariadb_car:
    image: mariadb:10.6
    container_name: mariadb_car
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-0000}
      MYSQL_DATABASE: car
    ports:
      - "3307:3306"
    volumes:
      - mariadb_car_data:/var/lib/mysql
      - ./car_db_init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-0000}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: --binlog-format=ROW --server-id=1 --log-bin=mysql-bin --binlog-do-db=car

  # Inventory 데이터베이스 (타겟 DB)
  mariadb_inventory:
    image: mariadb:10.6
    container_name: mariadb_inventory
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-0000}
      MYSQL_DATABASE: inventory_db
    ports:
      - "3308:3306"
    volumes:
      - mariadb_inventory_data:/var/lib/mysql
      - ./inventory_db_init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-0000}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_started
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://:29092,PLAINTEXT_HOST://:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 1
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data

  # Debezium Connect for CDC
  debezium:
    image: debezium/connect:2.4
    container_name: debezium
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_configs
      OFFSET_STORAGE_TOPIC: connect_offsets
      STATUS_STORAGE_TOPIC: connect_status
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: 'false'
      VALUE_CONVERTER_SCHEMAS_ENABLE: 'false'
      # MySQL connector 추가
      CONNECT_PLUGIN_PATH: /kafka/connect
    volumes:
      - ./debezium-plugins:/kafka/connect/debezium-connector-mysql

  # Spark Worker for processing
  spark-worker:
    build: .
    container_name: spark-worker
    depends_on:
      mariadb_inventory:
        condition: service_healthy
    environment:
      SPARK_HOME: /opt/spark
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      PYTHONPATH: /opt/spark/python:/opt/final_pj
      # Car DB 파이프라인 환경변수
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MARIADB_JDBC_URL: jdbc:mariadb://mariadb_inventory:3306/inventory_db?sessionVariables=sql_mode='ANSI_QUOTES'&useUnicode=true&characterEncoding=UTF-8
      MARIADB_USERNAME: root
      MARIADB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-0000}
      CHECKPOINT_DIR: /opt/spark_checkpoints/car_db_pipeline
    ports:
      - "4040:4040"
    volumes:
      - ./final_pj:/opt/final_pj
      - ./drivers:/opt/drivers
      - ./spark_checkpoints:/opt/spark_checkpoints
    working_dir: /opt/final_pj
    command: tail -f /dev/null  # 컨테이너 유지용

  airflow:
    build: .
    container_name: airflow
    depends_on:
      mariadb_inventory:
        condition: service_healthy
      kafka:
        condition: service_healthy
      spark-worker:
        condition: service_started
    environment:
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW_UID: ${AIRFLOW_UID:-50000}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: mysql+mysqlconnector://root:${MYSQL_ROOT_PASSWORD:-0000}@mariadb_inventory:3306/inventory_db
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      SPARK_HOME: /opt/spark
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      # Car DB 파이프라인 환경변수
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8080:8080"
    volumes:
      - ./dags:/opt/airflow/dags
      - ./final_pj:/opt/final_pj
      - ./drivers:/opt/drivers
      - ./spark_checkpoints:/opt/spark_checkpoints
    command: airflow standalone

volumes:
  mariadb_car_data:
  mariadb_inventory_data:
  kafka_data: